if (self.CavalryLogger) { CavalryLogger.start_js(["QEXIL"]); }

__d('legacy:tokenizer-token',['tokenizer-token'],(function a(b,c,d,e,f,g){b.token=c('tokenizer-token');}),3);
__d('FeedAdsGapRuleViolationDetectionFix',['csx','Banzai','BanzaiODS','CSS','DataAttributeUtils','DOM','ge','isEmpty','$'],(function a(b,c,d,e,f,g,h){var i='ei',j='qid',k='gap rule violation',l='non violating ads gap',m='non violating ego gap',n='first position violation',o='feed load',p='first position invalidation',q='spacing invalidation',r='ego_pymk',s='ego_other',t=[],u=[],v=[],w=[],x={},y={},z={},aa=[],ba={registerFeedStories:function ca(da,ea){if(da.containerID=='substream_0'){t=[];u=[];}var fa=c('ge')(da.containerID);if(!fa)return;z=da.egoGapRule;aa=da.invalidateEgo?da.egoStories:{};x=babelHelpers['extends']({},da.demoAdChecks,x);var ga=this._getAllStoriesFromContainer(fa);if(da.isLoggingEnabled&&ga.length!==0)this._logFeedLoad();if(da.isNewerStories){t=ga.concat(t);}else t=t.concat(ga);for(var ha in da.minGaps)if(Object.prototype.hasOwnProperty.call(da.minGaps,ha))y[ha]=da.minGaps[ha];if(c('isEmpty')(x)){if(da.isLoggingEnabled)this._checkFirstPosViolation(da,fa);if(da.isLoggingEnabled||da.isGapRuleInvalidationEnabled)this._checkGapRuleViolation(da);}},_getAllStoriesFromContainer:function ca(da){return c('DOM').scry(da,"div._5jmm").map(this._convertStoryNodeToObject).filter(function(ea){return ea!==null;});},_convertStoryNodeToObject:function ca(da){if(c('CSS').matchesSelector(da,"._170y"))return null;var ea=da.getAttribute('data-dedupekey');if(x[ea])return null;var fa=c('DOM').scry(da,"div._hye"),ga=c('DOM').scry(da,"li._170x"),ha=[];if(fa.length!==0){ha=fa.map(function(ka){return c('DataAttributeUtils').getDataFt(ka);}).filter(function(ka){return ka!==null;});}else if(ga.length!==0){ha=ga.map(function(ka){return c('DataAttributeUtils').getDataFt(ka);}).filter(function(ka){return ka!==null;});}else if(c('DataAttributeUtils').getDataFt(da))ha=[c('DataAttributeUtils').getDataFt(da)];if(!ha.length)return null;var ia=JSON.parse(ha[0]),ja={dataFTArray:ha,dedupKey:ea,isSponsored:!!ia[i],isEgoPymk:aa[ea]===r,isEgoOther:aa[ea]===s,height:da.offsetHeight,qid:parseInt(ia[j],10),nodeID:da.id};return ja;},_checkFirstPosViolation:function ca(da,ea){while(t.length>0&&t[0].isSponsored){var fa={ftArray:t[0].dataFTArray,qid:t[0].qid,nodeid:t[0].nodeID,firstStoryType:da.firstStoryType},ga=c('DOM').scry(ea,'.uiBoxRed')[0];if(ga){var ha=ga.textContent||ga.innerText;if(ha)fa.error_msg=ha;}if(da.isLoggingEnabled&&!(t[0].dedupKey in w)){this._logFirstPosViolation(fa);w[t[0].dedupKey]=fa;}break;}},_getMinGap:function ca(da,ea,fa){var ga=Math.min(da?da:Number.MAX_VALUE,ea?ea:Number.MAX_VALUE);return ga!==Number.MAX_VALUE?ga:fa;},_getStoryDedupKeys:function ca(){return t.map(function(da){return da.dedupKey;});},_getStoryDedupKeysJSONString:function ca(da,ea){var fa=[];for(var ga=da;ga<=ea;ga++)fa.push(t[ga].dedupKey);return JSON.stringify(fa);},_getIdxOfStoryToSwap:function ca(da,ea){if(ea>=t.length-da)return -1;for(var fa=da+1;fa<t.length&&ea>0;fa++){if(!t[fa].isSponsored&&!t[fa].isEgoPymk&&!t[fa].isEgoOther){ea--;}else return -1;if(ea===0)return fa;}return -1;},_checkGapRuleViolation:function ca(da){var ea=null,fa=null,ga=null;for(var ha=0;ha<t.length;ha++){var ia=t[ha],ja=c('ge')(ia.nodeID);if(!ja||!c('CSS').shown(ja)){t.splice(ha,1);continue;}if(ia.isSponsored){var ka=false,la=false;if(fa!==null){var ma=ha-fa,na=null,oa=null;if(ea===fa){oa=this._getMinGap(y[ga.dedupKey],y[ia.dedupKey],da.defaultMinGap);}else oa=this._getMinGapBetweenStories(ga,ia);var pa=null;if(ma<oa){na=k;pa=fa;}else{na=l;pa=ea;}if(da.isLoggingEnabled)if(!(ia.dedupKey in u)||u[ia.dedupKey].event_type!==na){this._logGapEvent(na,pa,ha);u[ia.dedupKey]={event_type:na};}if(da.isGapRuleInvalidationEnabled&&na==k){var qa=-1;if(da.isSwapOnGapRuleViolationEnabled)qa=this._getIdxOfStoryToSwap(ha,oa-ma);if(qa>0){this._shiftAdOrEgoBelowOrganicStory(ia.nodeID,t[qa].nodeID);var ra=t[ha];t.splice(ha,1);t.splice(qa,0,ra);if(da.isLoggingEnabled){var sa={ft:t[qa].dataFTArray[0],dist:qa-ha,qid:t[qa].qid,event_type:'ad_swap'};c('Banzai').post('feed_ads_gap_rule_violation',sa);}la=true;}else if(da.isGapRuleInvalidationEnabled){this._invalidateGapRuleViolatedAd(ga,ia);ka=true;t.splice(ha--,1);}}}if(!ka&&!la){ea=ha;fa=ha;ga=ia;}}if(da.invalidateEgo&&(ia.isEgoPymk||ia.isEgoOther)){var ta=false;if(fa!==null){ma=ha-fa;oa=this._getMinGapBetweenStories(ga,ia);if(ma<oa){ta=true;qa=-1;var ua=oa-ma;for(var va=ha+1;va<t.length;va++){if(t[va].isSponsored||t[va].isEgoPymk||t[va].isEgoOther){break;}else ua--;if(ua===0){qa=va;break;}}if(qa>0){this._swapAndLogEgo(ha,va);}else{this._invalidateAndLogEgo(ha);ha--;}}else if(da.shouldLogEgo&&!v[ia.dedupKey]){v[ia.dedupKey]=true;this._logGapEvent(m,fa,ha);}}if(!ta){fa=ha;ga=ia;}}}},_getMinGapBetweenStories:function ca(da,ea){var fa='';if(da.isSponsored||da.isEgoOther){fa='ad';}else if(da.isEgoPymk){fa='pymk';}else return 0;var ga='';if(ea.isSponsored||ea.isEgoOther){ga='ad';}else if(ea.isEgoPymk){ga='pymk';}else return 0;return z[fa+'_'+ga];},_swapAndLogEgo:function ca(da,ea){this._shiftAdOrEgoBelowOrganicStory(t[da].nodeID,t[ea].nodeID);var fa=t[da];t.splice(da,1);t.splice(ea,0,fa);c('BanzaiODS').bumpEntityKey('feed_ego_invalidation','swap');},_invalidateAndLogEgo:function ca(da){var ea=c('ge')(t[da].nodeID);ea&&c('CSS').hide(ea);t.splice(da,1);c('BanzaiODS').bumpEntityKey('feed_ego_invalidation','invalidate');},_logFirstPosViolation:function ca(da){var ea={ft:da.ftArray[0],event_type:n,intValues:{qid:da.qid},first_story_type:da.firstStoryType};if(da.error_msg)ea.error_msg=da.error_msg;c('Banzai').post('feed_ads_gap_rule_violation',ea);},_logGapEvent:function ca(da,ea,fa){if(ea===null)return;var ga=t[ea],ha=t[fa],ia=0;for(var ja=ea+1;ja<fa;ja++)ia+=t[ja].height;var ka={ft_A:ga.dataFTArray[0],ft_B:ha.dataFTArray[0],event_type:da,intValues:{dist:fa-ea,pdist:ia,pos:fa+1,qid_A:ga.qid,qid_B:ha.qid},strValues:{previous_unit_type:this._getUnitTypeForLogging(ga),unit_type:this._getUnitTypeForLogging(ha)},dedup_keys:this._getStoryDedupKeysJSONString(ea,fa)};c('Banzai').post('feed_ads_gap_rule_violation',ka);},_getUnitTypeForLogging:function ca(da){if(da.isSponsored){return 'ad';}else if(da.isEgoPymk){return 'pymk';}else if(da.isEgoOther)return 'ego_other';return null;},_logFeedLoad:function ca(){var da={event_type:o};c('Banzai').post('feed_ads_gap_rule_violation',da);},_invalidateFirstPosAd:function ca(da){c('CSS').hide(c('$')(da.nodeid));var ea={ft_array:da.ftArray,event_type:p};c('Banzai').post('feed_ads_gap_rule_violation',ea);},_invalidateGapRuleViolatedAd:function ca(da,ea){var fa=c('ge')(ea.nodeID);fa&&c('CSS').hide(fa);var ga={ft_array_A:da.dataFTArray[0],ft_array_B:ea.dataFTArray[0],event_type:q};c('Banzai').post('feed_ads_gap_rule_violation',ga);},_shiftAdOrEgoBelowOrganicStory:function ca(da,ea){var fa=c('ge')(da),ga=c('ge')(ea);fa&&ga&&c('DOM').insertAfter(ga,fa);}};f.exports=ba;}),null);